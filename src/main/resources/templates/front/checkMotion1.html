<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="UTF-8">
    <title>新建/修改提案</title><!--委员修改提案-->
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="libs/css/style.css">
</head>
<body>
<div class="layui-fluid layui-form" lay-filter="proposal">
    <form action="" class="layui-form-item layui-form" onsubmit="return false;">
        <div class="layui-form-item" style="padding-top:20px;">
            <label class="layui-form-label">案由：</label>
            <div class="layui-input-block">
                <input type="hidden" name="proposalId" id="proposalId" autocomplete="off" class="layui-input"
                       th:value="${proposalId}">
                <input type="text" placeholder="请输入提案案由" name="cause" required lay-verify="required" autocomplete="off"
                       class="layui-input" style="width: 800px">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">主导人：</label>
            <div class="layui-inline left">
                <input type="text" name="leader" readonly="readonly" id="realName" placeholder="请输入提案主导人" required
                       lay-verify="required" autocomplete="off" class="layui-input">
            </div>
            <label class="layui-form-label">联系电话：</label>
            <div class="layui-inline left">
                <input type="text" name="mobile" readonly="readonly" placeholder="请输入提案负责人手机号码" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">创办日期：</label>
            <div class="layui-inline left">
                <input type="text" class="layui-input" id="date" name="createTime">
            </div>

          <!--  <label class="layui-form-label">来源：</label>
            <div class="layui-inline left">
                <input type="text" name="period" required lay-verify="required" placeholder="请输入提案来源" autocomplete="off"
                       class="layui-input">
            </div>-->
        </div>


        <div class="layui-form-item">


            <label class="layui-form-label">届：</label>
            <div class="layui-inline left">
                <input type="text" class="layui-input" required lay-verify="required" autocomplete="off"  name="anniversary">
            </div>
            <label class="layui-form-label">次：</label>
            <div class="layui-inline left">
                <input type="text" name="number" required lay-verify="required" autocomplete="off" class="layui-input">
            </div>
            <label class="layui-form-label">提案类型：</label>
            <div class="layui-inline left">
                <select name="classify">
                    <option value="经济建设" selected="selected">经济建设</option>
                    <option value="政治建设">政治建设</option>
                    <option value="文化建设">文化建设</option>
                    <option value="社会建设">社会建设</option>
                    <option value="生态文明建设">生态文明建设</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">提案类别：</label>
            <div class="layui-inline left" style="width: 188px" lay-search="">
                <select name="type" lay-filter="search_type">
                    <option value="个人提案">个人提案</option>
                    <option value="个人联名提案"selected="selected">个人联名提案</option>
                    <option value="团体提案" >团体提案</option>
                    <option value="党派提案">党派提案</option>
                    <option value="委员小组提案">委员小组提案</option>
                    <option value="界别组提案">界别组提案</option>
                    <option value="专门委员会提案">专门委员会提案</option>
                </select>
            </div>
            <label class="layui-form-label">单位：</label>
            <div class="layui-inline left">
                <input type="text" name="specifica" required lay-verify="required" autocomplete="off" class="layui-input" placeholder="如:个人提案则注明单位" >
            </div>

        </div>


        <div class="layui-form-item">
            <div id="test3" class="demo-transfer layui-inline left"></div>
            <div id="buchong">
                <p>联名用户补充：</p>
                <textarea name="peoples" style="word-break: break-all;height: 334px;width: 260px"
                          placeholder="用户之间用，逗号隔开"></textarea>
            </div>

            <!-- <div id="test2" class="demo-transfer layui-inline left"></div>-->
        </div>

        <div class="layui-form-item motion-form">
            <label class="layui-form-label">选项勾选：</label>
            <div class="layui-input-block">
                <input type="checkbox" name="isWrite" title="是否本人撰写" value="1">
                <input type="checkbox" name="isResearch" title="是否经过调研" value="1">
                <input type="checkbox" name="isTopic" title="是否参考提案选题" value="1">
                <input type="checkbox" name="isMaterials" title="是否转呈他人材料" value="1">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label"></label>
            <div class="layui-input-block" disabled="true">
                <textarea id="editAera" name="content" style="display: none;"></textarea>
            </div>
        </div>

        <div class="layui-form-item" id="uploading">
            <label class="layui-form-label"></label>
            <div class="layui-inline left" id="downloadtwo">提案附件:
                <button type="button" class="layui-btn layui-btn-red" id="upload">
                    <i class="layui-icon">&#xe67c;</i>附件上传
                </button>
            </div>
        </div>




        <div class="layui-form-item text-c">
            <div class="layui-inline">
                <button type="button" class="layui-btn layui-btn-red" lay-submit="" lay-filter="proposal" id="proposal">
                    提交提案
                </button>
            </div>
            <div class="layui-inline">
                <button type="button" class="layui-btn layui-btn-red" id="toClose">关闭页面</button>
            </div>
        </div>

    </form>
</div>

<script src="layui/layui.js"></script>
<script>
    layui.use(['transfer', 'layedit', 'laydate', 'table', 'form', 'upload', "element", "jquery", 'util'], function () {
        var upload = layui.upload;
        var table = layui.table
            , layedit = layui.layedit
            , transfer = layui.transfer
            , form = layui.form
            , element = layui.element
            , $ = layui.jquery
            , util = layui.util;

        layedit.set({
            uploadImage: {
                url: 'picture' //接口url
                , type: 'POST' //默认post
            }
        });
        var index = layedit.build('editAera', {//建立编辑器
            height: 1000 //设置编辑器高度
        });

        var laydate = layui.laydate;


        // 设置最小可选的日期
        function minDate() {
            var now = new Date();
            return now.getFullYear() + "-" + (now.getMonth() + 1) + "-" + now.getDate();
        }

        //回显数据
        $.ajax({
            url: "parent/lookProposal/" + $("#proposalId").val(),
            type: "GET",
            data: {},
            dataType: "json",
            success: function (data) {
                form.val('proposal', {
                    "cause": data.cause
                    , "createTime": data.createTime
                   // , "period": data.period//来源
                    , "classify": data.classify//提案类别
                    // , "status": data.status
                    , "anniversary": data.anniversary//届
                    , "number": data.number//次
                    , "leader": data.leader//主导人
                    , "mobile": data.mobile//手机
                    , "statusName": data.statusName
                    , "type": data.type//提案分类
                    // , "unitId": data.unitId
                    , "isWrite": data.isWrite
                    , "isResearch": data.isResearch
                    , "isTopic": data.isTopic
                    , "isMaterials": data.isMaterials
                    , "peoples": data.peoples
                    ,"specifica":data.specifica


                });

                if (data.type == '个人提案') {
                    $("#test3").css('display', 'none');
                    $("#buchong").css('display', 'none');
                } else {
                    $("#test3").css('display', 'block');
                    $("#buchong").css('display', 'block');
                }
                layedit.setContent(index, data.content, true);
            }
        });

        $.ajax({
            url: "selectapd/" + $("#proposalId").val() + '/1',
            type: "GET",
            dataType: "json",
            success: function (msg) {
                if (msg.datas == '-1') {
                    // $("#download").css('display', 'none');
                } else {
                    $("#downloadtwo").append('<a  class="layui-btn-red layui-download" href="file/' + msg.datas.appendixId + '" style="color: blue">' + msg.datas.appendixName + '</a>');
                }
            },
            error: function (error) {
                alert("异常");
            }

        });

        //联名人
        $.ajax({
            url: "front/user/findsel",
            data: {},
            type: "GET",
            dataType: "json",
            success: function (msg) {
                $.ajax({
                    url: "front/user/jointuser",
                    data: {
                        "proposalId": $("#proposalId").val()
                    },
                    type: "GET",
                    dataType: "json",
                    success: function (msg1) {
                        var joint = JSON.parse(msg1.userData);
                        //初始右侧数据
                        transfer.render({
                            elem: '#test3'
                            , data: msg
                            , title: ['用户列表', '联名用户']
                            , showSearch: true
                            , id: 'demo1'
                            , value: joint
                            , parseData: function (msg) {
                                return {
                                    "value": msg.userId //数据值
                                    , "title": msg.realName //数据标题
                                }
                            }
                        });
                    }
                });
            }
        });



        // 日期
        layui.use('laydate', function () {
            var laydate = layui.laydate;
            //执行一个laydate实例
            laydate.render({
                elem: '#date' //指定元素
                , theme: '#c50e10'
            });
        });


        // 下拉框改变触发
        form.on('select(search_type)', function (data) {
            //alert(data.value)
            if (data.value == '个人提案') {
                $("#test3").css('display', 'none');
            } else {
                $("#test3").css('display', 'block');
            }

        });

        $("#test3").css('display', 'none');

        form.on('submit(proposal)', function (data) {
            data.field.createTime = new Date(data.field.createTime);
           // data.field.lastTime = new Date(data.field.lastTime);
            data.field.content = layedit.getContent(index);
            var getData = [];
            var valueone = [];//用户id
            var peoples = '';//联名用户
            getData = transfer.getData('demo1'); //获取用户右侧数据

            for (var w = 0; w < getData.length; w++) {
                valueone[w] = getData[w].value;
                peoples += getData[w].title
                if (w < getData.length - 1) {
                    peoples += '，'
                }
            }
            data.field.peoples = peoples;
          //  console.log("1234546")
            $.ajax({
                url: "front/members/mbSubReply",
                data: data.field,
                type: "POST",
                dataType: "json",
                success: function (msg) {
                    $("#proposalId").val(msg.datas.proposalId);
                    if (data.field.type != '个人提案') {
                        $.ajax({//联名人
                            url: "front/user/addPersons?proposalId=" + msg.datas.proposalId + "&users=" + valueone,
                            type: "POST",
                            dataType: "json",
                            success: function (msgw) {
                                layer.msg(msg.resp_msg, {icon: 1, time: 1500}, function () {
                                    parent.layui.layer.closeAll();
                                });

                            }
                        });
                    }

                    if (data.field.type == '个人提案') {
                            layer.msg(msg.resp_msg, {icon: 1, time: 1500}, function () {
                                parent.layui.layer.closeAll();
                            });
                    }


                },
                error: function (error) {
                    alert("异常")
                }
            });
        });


        //执行实例   提案附件
        var uploadInst = upload.render({
            elem: '#upload' //绑定元素
            , url: 'upload?proposalId=' + $("#proposalId").val() + '&type=1' //上传接口
            , accept: 'file' //允许上传的文件类型
            , size: 20480 //最大允许上传的文件大小
            , done: function (res) {
                $("#downloadtwo a").remove();
                $("#downloadtwo").append('<a  class="layui-btn-red layui-download" href="file/' + res.datas.appendixId + '" style="color: blue">' + res.datas.appendixName + '</a>');
            }
            , error: function () {
                //请求异常回调
                layer.alert("后台出错", {
                    icon: 5,
                    title: "提示"
                });
            }
        });



        // 关闭页面
        $("#toClose").on("click", function () {
            parent.layui.layer.closeAll();
        });

    });
</script>
</body>
</html>
